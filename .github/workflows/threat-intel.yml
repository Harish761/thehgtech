# .github/workflows/threat-intel.yml
# Automated Threat Intelligence Feed from AlienVault OTX
# 
# Schedule:
# - Hourly: Fetch new IOCs, clean expired ones (max 20 IOCs, 24h rolling window)
# - Daily at 12:00 AM IST (6:30 PM UTC): Calculate 24h summary statistics

name: Update Threat Intelligence

on:
  schedule:
    # Run hourly at minute 0
    - cron: '0 * * * *'
    # Run daily at 6:30 PM UTC (12:00 AM IST next day)
    - cron: '30 18 * * *'
  workflow_dispatch:
    inputs:
      run_type:
        description: 'Type of update to run'
        required: true
        default: 'hourly'
        type: choice
        options:
          - hourly
          - daily
          - both

jobs:
  update-threat-intel:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Determine run type
        id: run_type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.run_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" = "30 18 * * *" ]; then
            echo "type=daily" >> $GITHUB_OUTPUT
          else
            echo "type=hourly" >> $GITHUB_OUTPUT
          fi
      
      - name: Run threat intel update
        env:
          OTX_API_KEY: ${{ secrets.OTX_API_KEY }}
        run: |
          if [ "${{ steps.run_type.outputs.type }}" = "hourly" ]; then
            python fetch_threat_intel.py --hourly
          elif [ "${{ steps.run_type.outputs.type }}" = "daily" ]; then
            python fetch_threat_intel.py --daily
          else
            python fetch_threat_intel.py --both
          fi
      
      - name: Check for changes
        id: git_status
        run: |
          if git diff --quiet threat-intel.js; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit and push changes
        if: steps.git_status.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add threat-intel.js
          
          # Also add history file if it exists
          if [ -f "threat-intel-history.json" ]; then
            git add threat-intel-history.json
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          RUN_TYPE="${{ steps.run_type.outputs.type }}"
          
          git commit -m "ðŸ”’ Update threat intel ($RUN_TYPE) - $TIMESTAMP"
          git push
      
      - name: Summary
        run: |
          echo "## Threat Intelligence Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Type:** ${{ steps.run_type.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Committed:** ${{ steps.git_status.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "threat-intel.js" ]; then
            IOC_COUNT=$(grep -c '"indicator":' threat-intel.js || echo "0")
            echo "- **Current IOC Count:** $IOC_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
