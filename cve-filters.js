/**
 * CVE Filters - Premium Filter Panel for CVE Tracker
 * Provides powerful filtering and search capabilities for CVEs
 */

(function () {
    'use strict';

    class CVEFilter {
        constructor() {
            this.allCVEs = [];
            this.filteredCVEs = [];
            this.activeFilters = {};
            this.searchDebounceTimer = null;
            this.initialized = false;
        }

        initialize() {
            if (this.initialized) return;

            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.setup());
            } else {
                this.setup();
            }
        }

        setup() {
            // Wait for CVE data to load
            this.waitForCVEData();
        }

        waitForCVEData() {
            // Check if cveData is available
            if (typeof cveData !== 'undefined' && cveData && cveData.cves) {
                this.allCVEs = cveData.cves.slice(0, 50);
                this.filteredCVEs = [...this.allCVEs];
                this.createFilterPanel();
                this.attachEventListeners();
                this.initialized = true;
                console.log('✅ CVE Advanced Filters initialized with', this.allCVEs.length, 'CVEs');
            } else {
                // Retry after a delay
                setTimeout(() => this.waitForCVEData(), 500);
            }
        }

        createFilterPanel() {
            // Find insertion point (before cve-grid or after cve-header)
            const cveHeader = document.querySelector('.cve-header');
            const cveGrid = document.querySelector('.cve-grid');

            if (!cveHeader && !cveGrid) {
                console.warn('CVE container not found, skipping filter panel');
                return;
            }

            // Get unique vendors for dropdown
            const vendors = [...new Set(this.allCVEs.map(c => c.vendor))].sort();

            // Create filter panel HTML
            const filterPanel = document.createElement('div');
            filterPanel.className = 'filter-panel';
            filterPanel.id = 'cveFilterPanel';
            filterPanel.innerHTML = `
                <div class="filter-header">
                    <h3 class="filter-title">
                        <i class="fas fa-filter"></i> Advanced Filters
                    </h3>
                    <button class="filter-toggle" id="toggleCVEFilters">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                
                <div class="filter-content" id="cveFilterContent">
                    <div class="filter-search">
                        <input type="text" 
                               id="cveSearch" 
                               placeholder="Search by CVE ID, vendor, product, or description..."
                               autocomplete="off">
                        <button class="search-btn" id="cveSearchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    
                    <div class="filter-controls">
                        <div class="filter-group">
                            <label class="filter-label" for="filterSeverity">Severity</label>
                            <select id="filterSeverity">
                                <option value="all">All Severities</option>
                                <option value="CRITICAL">Critical</option>
                                <option value="HIGH">High</option>
                                <option value="MEDIUM">Medium</option>
                                <option value="LOW">Low</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label" for="filterVendor">Vendor</label>
                            <select id="filterVendor">
                                <option value="all">All Vendors</option>
                                ${vendors.map(v => `<option value="${v}">${v}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label" for="filterEPSS">EPSS Score</label>
                            <select id="filterEPSS">
                                <option value="all">All EPSS Scores</option>
                                <option value="critical">Critical (≥70%)</option>
                                <option value="high">High (≥50%)</option>
                                <option value="medium">Medium (≥30%)</option>
                                <option value="low">Low (<30%)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label" for="filterZeroDay">Zero-Day</label>
                            <select id="filterZeroDay">
                                <option value="all">All CVEs</option>
                                <option value="yes">Zero-Day Only</option>
                                <option value="no">Exclude Zero-Days</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="active-filters" id="activeCVEFilters"></div>
                    
                    <div class="filter-actions">
                        <div class="filter-results">
                            <span class="result-count" id="cveResultCount">${this.allCVEs.length}</span>
                            <span class="result-label">CVEs found</span>
                        </div>
                        <button class="clear-filters-btn" id="clearCVEFilters">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>
                </div>
            `;

            // Insert after cve-header or before cve-grid
            if (cveHeader) {
                cveHeader.after(filterPanel);
            } else if (cveGrid) {
                cveGrid.before(filterPanel);
            }
        }

        attachEventListeners() {
            // Search input with debounce
            const searchInput = document.getElementById('cveSearch');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    clearTimeout(this.searchDebounceTimer);
                    this.searchDebounceTimer = setTimeout(() => {
                        this.applyFilters();
                    }, 300);
                });

                // Enter key triggers immediate search
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        clearTimeout(this.searchDebounceTimer);
                        this.applyFilters();
                    }
                });
            }

            // Search button
            const searchBtn = document.getElementById('cveSearchBtn');
            if (searchBtn) {
                searchBtn.addEventListener('click', () => this.applyFilters());
            }

            // Filter dropdowns
            ['filterSeverity', 'filterVendor', 'filterEPSS', 'filterZeroDay'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => this.applyFilters());
                }
            });

            // Clear filters button
            const clearBtn = document.getElementById('clearCVEFilters');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => this.clearAllFilters());
            }

            // Toggle filters visibility
            const toggleBtn = document.getElementById('toggleCVEFilters');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => this.toggleFilters());
            }
        }

        applyFilters() {
            const search = document.getElementById('cveSearch')?.value.toLowerCase().trim() || '';
            const severity = document.getElementById('filterSeverity')?.value || 'all';
            const vendor = document.getElementById('filterVendor')?.value || 'all';
            const epss = document.getElementById('filterEPSS')?.value || 'all';
            const zeroDay = document.getElementById('filterZeroDay')?.value || 'all';

            // Store active filters
            this.activeFilters = {
                search: search || null,
                severity: severity !== 'all' ? severity : null,
                vendor: vendor !== 'all' ? vendor : null,
                epss: epss !== 'all' ? epss : null,
                zeroDay: zeroDay !== 'all' ? zeroDay : null
            };

            // Apply filters
            this.filteredCVEs = this.allCVEs.filter(cve => {
                // Search filter
                if (search && !this.matchesSearch(cve, search)) {
                    return false;
                }

                // Severity filter
                if (severity !== 'all' && cve.severity !== severity) {
                    return false;
                }

                // Vendor filter
                if (vendor !== 'all' && cve.vendor !== vendor) {
                    return false;
                }

                // EPSS filter
                if (epss !== 'all' && !this.matchesEPSS(cve, epss)) {
                    return false;
                }

                // Zero-Day filter
                if (zeroDay === 'yes' && !cve.isZeroDay) {
                    return false;
                }
                if (zeroDay === 'no' && cve.isZeroDay) {
                    return false;
                }

                return true;
            });

            this.updateDisplay();
            this.updateActiveFilterBadges();
        }

        matchesSearch(cve, search) {
            const searchableFields = [
                cve.cveId,
                cve.vendor,
                cve.product,
                cve.description,
                cve.severity
            ].filter(Boolean).join(' ').toLowerCase();

            return searchableFields.includes(search);
        }

        matchesEPSS(cve, epssRange) {
            if (!cve.epss) return epssRange === 'low'; // No EPSS = treat as low

            const score = cve.epss.score;
            switch (epssRange) {
                case 'critical':
                    return score >= 0.7;
                case 'high':
                    return score >= 0.5 && score < 0.7;
                case 'medium':
                    return score >= 0.3 && score < 0.5;
                case 'low':
                    return score < 0.3;
                default:
                    return true;
            }
        }

        updateDisplay() {
            this.updateResultCount();

            // Hide/show CVE cards based on filter
            const cveCards = document.querySelectorAll('.cve-card');
            const filteredIds = new Set(this.filteredCVEs.map(c => c.cveId));

            cveCards.forEach(card => {
                const cveId = card.getAttribute('data-cve-id');
                if (filteredIds.has(cveId)) {
                    card.style.display = '';
                    card.style.opacity = '1';
                } else {
                    card.style.display = 'none';
                }
            });

            // Show "no results" message if needed
            this.showNoResultsMessage(this.filteredCVEs.length === 0);
        }

        showNoResultsMessage(show) {
            let noResults = document.getElementById('cveNoResults');

            if (show) {
                if (!noResults) {
                    noResults = document.createElement('div');
                    noResults.id = 'cveNoResults';
                    noResults.className = 'cve-no-results';
                    noResults.innerHTML = `
                        <div class="no-results-icon"><i class="fas fa-search"></i></div>
                        <div class="no-results-title">No CVEs Found</div>
                        <div class="no-results-text">Try adjusting your filters or search terms</div>
                        <button class="clear-filters-btn" onclick="window.cveFilter.clearAllFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    `;
                    const cveGrid = document.querySelector('.cve-grid');
                    if (cveGrid) {
                        cveGrid.after(noResults);
                    }
                }
                noResults.style.display = 'flex';
            } else if (noResults) {
                noResults.style.display = 'none';
            }
        }

        updateResultCount() {
            const countElement = document.getElementById('cveResultCount');
            if (countElement) {
                countElement.textContent = this.filteredCVEs.length;
            }
        }

        updateActiveFilterBadges() {
            const container = document.getElementById('activeCVEFilters');
            if (!container) return;

            container.innerHTML = '';

            const badges = [];

            if (this.activeFilters.search) {
                badges.push(this.createBadge('Search', `"${this.activeFilters.search}"`, 'search'));
            }
            if (this.activeFilters.severity) {
                badges.push(this.createBadge('Severity', this.activeFilters.severity, 'severity'));
            }
            if (this.activeFilters.vendor) {
                badges.push(this.createBadge('Vendor', this.activeFilters.vendor, 'vendor'));
            }
            if (this.activeFilters.epss) {
                const epssLabels = {
                    'critical': 'Critical (≥70%)',
                    'high': 'High (≥50%)',
                    'medium': 'Medium (≥30%)',
                    'low': 'Low (<30%)'
                };
                badges.push(this.createBadge('EPSS', epssLabels[this.activeFilters.epss], 'epss'));
            }
            if (this.activeFilters.zeroDay) {
                badges.push(this.createBadge('Zero-Day', this.activeFilters.zeroDay === 'yes' ? 'Only' : 'Excluded', 'zeroDay'));
            }

            badges.forEach(badge => container.appendChild(badge));
        }

        createBadge(label, value, filterKey) {
            const badge = document.createElement('div');
            badge.className = 'filter-badge';
            badge.innerHTML = `
                <span>${label}: ${value}</span>
                <button class="filter-badge-remove" data-filter="${filterKey}">×</button>
            `;

            badge.querySelector('.filter-badge-remove').addEventListener('click', () => {
                this.removeFilter(filterKey);
            });

            return badge;
        }

        removeFilter(filterKey) {
            switch (filterKey) {
                case 'search':
                    document.getElementById('cveSearch').value = '';
                    break;
                case 'severity':
                    document.getElementById('filterSeverity').value = 'all';
                    break;
                case 'vendor':
                    document.getElementById('filterVendor').value = 'all';
                    break;
                case 'epss':
                    document.getElementById('filterEPSS').value = 'all';
                    break;
                case 'zeroDay':
                    document.getElementById('filterZeroDay').value = 'all';
                    break;
            }
            this.applyFilters();
        }

        clearAllFilters() {
            document.getElementById('cveSearch').value = '';
            document.getElementById('filterSeverity').value = 'all';
            document.getElementById('filterVendor').value = 'all';
            document.getElementById('filterEPSS').value = 'all';
            document.getElementById('filterZeroDay').value = 'all';

            this.activeFilters = {};
            this.applyFilters();
        }

        toggleFilters() {
            const content = document.getElementById('cveFilterContent');
            const toggleBtn = document.getElementById('toggleCVEFilters');
            const icon = toggleBtn.querySelector('i');

            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        getFilteredCVEs() {
            return this.filteredCVEs;
        }
    }

    // Create global instance
    window.cveFilter = new CVEFilter();
    window.cveFilter.initialize();

})();
