/**
 * CVE Display - Beautiful Interactive CVE Section
 * Displays CISA KEV vulnerabilities with NVD remediation links
 */

// Global CVE data
let cveData = null;

// Load CVE data
async function loadCVEData() {
    try {
        const response = await fetch('cve-data.json?t=' + Date.now());
        cveData = await response.json();
        console.log(`✓ Loaded ${cveData.totalCVEs} CVEs`);
        renderCVESection();
    } catch (error) {
        console.error('Failed to load CVE data:', error);
        showCVEError();
    }
}

// Render CVE section on homepage
function renderCVESection() {
    const container = document.getElementById('cveContainer');
    if (!container || !cveData) return;

    const cves = cveData.cves.slice(0, 10); // Show top 10 most recent

    let html = `
        <div class="cve-header">
            <div class="cve-header-content">
                <h2 class="cve-title">
                    Critical Vulnerabilities Tracker
                </h2>
                <p class="cve-subtitle">CISA Known Exploited Vulnerabilities with Remediation Links</p>
            </div>
            <div class="cve-stats">
                <div class="cve-stat">
                    <span class="cve-stat-value">${cveData.totalCVEs}</span>
                    <span class="cve-stat-label">Active CVEs</span>
                </div>
                <div class="cve-stat">
                    <span class="cve-stat-value">${cves.filter(c => c.severity === 'CRITICAL').length}</span>
                    <span class="cve-stat-label">Critical</span>
                </div>
            </div>
        </div>

        <div class="cve-grid">
    `;

    cves.forEach((cve, index) => {
        const severityClass = cve.severity.toLowerCase();
        const severityColor = getSeverityColor(cve.severity);
        const hasRemediation = cve.remediationLinks && cve.remediationLinks.length > 0;

        html += `
            <div class="cve-card" 
                 data-cve-id="${cve.cveId}"
                 onclick="openCVEModal('${cve.cveId}')"
                 style="animation-delay: ${index * 0.05}s">
                
                <div class="cve-card-header">
                    <div class="cve-badges">
                        <div class="cve-severity-badge ${severityClass}" style="background: ${severityColor}">
                            ${cve.severity}
                        </div>
                        ${cve.isZeroDay ? '<div class="cve-zero-day-badge">ZERO DAY</div>' : ''}
                    </div>
                    <div class="cve-date">${formatDate(cve.dateAdded)}</div>
                </div>

                <div class="cve-card-body">
                    <h3 class="cve-id">${cve.cveId}</h3>
                    <p class="cve-vendor">${cve.vendor} ${cve.product}</p>
                    <p class="cve-description">${cve.description}</p>
                </div>

                <div class="cve-card-footer">
                    ${hasRemediation ? `
                        <div class="cve-remediation-indicator">
                            ${cve.remediationLinks.length} Fix${cve.remediationLinks.length > 1 ? 'es' : ''} Available
                        </div>
                    ` : `
                        <div class="cve-remediation-indicator no-links">
                            See CISA Guidance
                        </div>
                    `}
                    <div class="cve-due-date">
                        Due: ${formatDate(cve.dueDate)}
                    </div>
                </div>
            </div>
        `;
    });

    html += `
        </div>
        <div class="cve-view-all">
            <a href="https://www.cisa.gov/known-exploited-vulnerabilities-catalog" 
               target="_blank" 
               class="cve-view-all-btn">
                View Full CISA KEV Catalog →
            </a>
        </div>
    `;

    container.innerHTML = html;
}

// Open CVE modal with full details
function openCVEModal(cveId) {
    const cve = cveData.cves.find(c => c.cveId === cveId);
    if (!cve) return;

    const modal = document.getElementById('cveModal') || createCVEModal();
    const severityColor = getSeverityColor(cve.severity);

    const modalContent = `
        <div class="cve-modal-header" style="border-left: 5px solid ${severityColor}">
            <div class="cve-modal-title-section">
                <h2 class="cve-modal-title">${cve.cveId}</h2>
                <div class="cve-severity-badge ${cve.severity.toLowerCase()}" style="background: ${severityColor}">
                    ${cve.severity}
                </div>
                ${cve.isZeroDay ? '<div class="cve-zero-day-badge">ZERO DAY</div>' : ''}
            </div>
            <button class="cve-modal-close" onclick="closeCVEModal()">✕</button>
        </div>

        <div class="cve-modal-body">
            <div class="cve-modal-section">
                <h3>Vulnerability Details</h3>
                <div class="cve-detail-grid">
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Vendor:</span>
                        <span class="cve-detail-value">${cve.vendor}</span>
                    </div>
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Product:</span>
                        <span class="cve-detail-value">${cve.product}</span>
                    </div>
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Date Added:</span>
                        <span class="cve-detail-value">${formatDate(cve.dateAdded)}</span>
                    </div>
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Remediation Due:</span>
                        <span class="cve-detail-value">${formatDate(cve.dueDate)}</span>
                    </div>
                </div>
            </div>

            <div class="cve-modal-section">
                <h3>Description</h3>
                <p class="cve-modal-description">${cve.description}</p>
                ${cve.shortDescription ? `<p class="cve-modal-short-desc">${cve.shortDescription}</p>` : ''}
            </div>

            <div class="cve-modal-section">
                <h3>Required Action</h3>
                <div class="cve-required-action">
                    ${cve.requiredAction}
                </div>
            </div>

            ${cve.remediationLinks && cve.remediationLinks.length > 0 ? `
                <div class="cve-modal-section">
                    <h3>Vendor Patches & Advisories</h3>
                    <div class="cve-remediation-links">
                        ${cve.remediationLinks.map(link => `
                            <a href="${link.url}" target="_blank" class="cve-remediation-link">
                                <span class="remediation-link-text">${link.title}</span>
                                <span class="remediation-link-arrow">→</span>
                            </a>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            <div class="cve-modal-section">
                <h3>Official References</h3>
                <div class="cve-official-links">
                    <a href="${cve.nvdUrl}" target="_blank" class="cve-official-link">
                        <span>NVD Details</span>
                        <span>→</span>
                    </a>
                    <a href="${cve.cisaUrl}" target="_blank" class="cve-official-link">
                        <span>CISA KEV Catalog</span>
                        <span>→</span>
                    </a>
                </div>
            </div>
        </div>
    `;

    modal.querySelector('.cve-modal-content-inner').innerHTML = modalContent;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Close CVE modal
function closeCVEModal() {
    const modal = document.getElementById('cveModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Create CVE modal element
function createCVEModal() {
    const modal = document.createElement('div');
    modal.id = 'cveModal';
    modal.className = 'cve-modal';
    modal.innerHTML = `
        <div class="cve-modal-overlay" onclick="closeCVEModal()"></div>
        <div class="cve-modal-content">
            <div class="cve-modal-content-inner"></div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

// Get severity color
function getSeverityColor(severity) {
    const colors = {
        'CRITICAL': 'linear-gradient(135deg, #FF3D3D, #C41E3A)',
        'HIGH': 'linear-gradient(135deg, #FF8C00, #FF6B35)',
        'MEDIUM': 'linear-gradient(135deg, #FFA500, #FFB84D)',
        'LOW': 'linear-gradient(135deg, #4CAF50, #66BB6A)'
    };
    return colors[severity] || colors['HIGH'];
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

// Show error message
function showCVEError() {
    const container = document.getElementById('cveContainer');
    if (!container) return;

    container.innerHTML = `
        <div class="cve-error">
            <p>Unable to load CVE data. Please try again later.</p>
        </div>
    `;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('cveContainer')) {
        loadCVEData();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeCVEModal();
    }
});

// Update hero KEV count when CVE data loads
document.addEventListener('DOMContentLoaded', () => {
    // Update hero count after CVE data loads
    const originalLoadCVEData = window.loadCVEData;
    if (typeof originalLoadCVEData === 'function') {
        window.loadCVEData = async function() {
            await originalLoadCVEData();
            if (cveData && cveData.totalCVEs) {
                const heroCount = document.getElementById('heroKevCount');
                if (heroCount) {
                    heroCount.textContent = cveData.totalCVEs;
                }
            }
        };
    }
});
