/**
 * CVE Display - Beautiful Interactive CVE Section
 * Displays CISA KEV vulnerabilities with NVD remediation links
 */

// Global CVE data
let cveData = null;

// Load CVE data
async function loadCVEData() {
    const container = document.getElementById('cveContainer');

    // Show skeleton loaders while loading
    if (container) {
        container.innerHTML = `
            <div class="cve-header">
                <div class="skeleton-loader" style="width: 300px; height: 32px; margin-bottom: 1rem;"></div>
                <div class="skeleton-loader" style="width: 200px; height: 20px;"></div>
            </div>
            <div class="cve-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                ${Array(6).fill(`
                    <div class="skeleton-card" style="border-left: 4px solid rgba(255, 61, 61, 0.5); padding: 1.25rem;">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <div class="skeleton-loader skeleton-badge" style="width: 80px;"></div>
                            <div class="skeleton-loader skeleton-badge" style="width: 60px;"></div>
                        </div>
                        <div class="skeleton-loader skeleton-title" style="width: 80%; margin-bottom: 0.75rem;"></div>
                        <div class="skeleton-loader skeleton-text" style="width: 60%; margin-bottom: 0.5rem;"></div>
                        <div class="skeleton-loader skeleton-text" style="width: 100%; margin-bottom: 0.5rem;"></div>
                        <div class="skeleton-loader skeleton-text" style="width: 75%;"></div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    try {
        const response = await fetch('cve-data.json?t=' + Date.now());
        cveData = await response.json();
        console.log(`‚úì Loaded ${cveData.totalCVEs} CVEs`);
        renderCVESection();
    } catch (error) {
        console.error('Failed to load CVE data:', error);
        showCVEError();
    }
}

// Render CVE section on homepage
function renderCVESection() {
    const container = document.getElementById('cveContainer');
    if (!container || !cveData) return;

    const cves = cveData.cves.slice(0, 20); // Show top 20 most recent

    let html = `
        <div class="cve-header">
            <div class="cve-header-content">
                <h2 class="cve-title">
                    Critical Vulnerabilities Tracker
                </h2>
                <p class="cve-subtitle">CISA Known Exploited + NVD Critical Vulnerabilities with Remediation Links</p>
            </div>
            <div class="cve-stats">
                <div class="cve-stat">
                    <span class="cve-stat-value">${cves.length}</span>
                    <span class="cve-stat-label">Active CVEs</span>
                </div>
                <div class="cve-stat">
                    <span class="cve-stat-value">${cves.filter(c => c.severity === 'CRITICAL').length}</span>
                    <span class="cve-stat-label">Critical</span>
                </div>
                <div class="cve-stat">
                    <span class="cve-stat-value">${cves.filter(c => c.patchPriority === 'CRITICAL-URGENT').length}</span>
                    <span class="cve-stat-label">Urgent</span>
                </div>
                <div class="cve-stat epss-stat">
                    <span class="cve-stat-value">${cves.filter(c => c.epss && c.epss.score >= 0.5).length}</span>
                    <span class="cve-stat-label">High EPSS</span>
                </div>
            </div>
            <div class="cve-data-note">
                <small>üìä Showing top 20 critical CVEs with EPSS exploit prediction scores (CISA KEV + NVD Critical CVSS ‚â• 9.0)</small>
            </div>
            <div class="cve-epss-info-note">
                <span class="epss-info-icon">‚ÑπÔ∏è</span>
                <span class="epss-info-text">
                    <strong>What is EPSS?</strong> The Exploit Prediction Scoring System (EPSS) by <a href="https://www.first.org/epss/" target="_blank" rel="noopener">FIRST.org</a> predicts the likelihood a CVE will be exploited in the next 30 days. 
                    CVEs without EPSS bars are pending scoring ‚Äî FIRST.org typically adds scores within 1-3 days of CVE publication.
                </span>
            </div>
        </div>

        <div class="cve-grid">
    `;

    cves.forEach((cve, index) => {
        const severityClass = cve.severity.toLowerCase();
        const severityColor = getSeverityColor(cve.severity);
        const hasRemediation = cve.remediationLinks && cve.remediationLinks.length > 0;

        html += `
            <div class="cve-card" 
                 data-cve-id="${cve.cveId}"
                 onclick="openCVEModal('${cve.cveId}')"
                 style="animation-delay: ${index * 0.05}s">
                
                <div class="cve-card-header">
                    <div class="cve-badges">
                        <div class="cve-severity-badge ${severityClass}" style="background: ${severityColor}">
                            ${cve.severity}
                        </div>
                        ${cve.isZeroDay ? '<div class="cve-zero-day-badge">ZERO DAY</div>' : ''}
                        ${cve.cvssVersion === '4.0' ? '<div class="cve-version-badge">CVSS 4.0</div>' : ''}
                        ${cve.cvssScore === 10.0 ? '<div class="cve-perfect-score-badge">10.0</div>' : ''}
                        ${getPriorityBadge(cve.patchPriority)}
                    </div>
                    <div class="cve-date">${formatDate(cve.dateAdded)}</div>
                </div>
                
                ${cve.epss ? `
                <div class="cve-epss-bar">
                    <div class="cve-epss-label">
                        <span>EPSS</span>
                        <span class="cve-epss-value ${getEPSSClass(cve.epss.score)}">${(cve.epss.score * 100).toFixed(1)}%</span>
                    </div>
                    <div class="cve-epss-track">
                        <div class="cve-epss-fill ${getEPSSClass(cve.epss.score)}" style="width: ${cve.epss.score * 100}%"></div>
                    </div>
                </div>
                ` : ''}

                <div class="cve-card-body">
                    <h3 class="cve-id">${cve.cveId}</h3>
                    <p class="cve-vendor">${cve.vendor} ${cve.product}</p>
                    <p class="cve-description">${cve.description}</p>
                </div>

                <div class="cve-card-footer">
                    ${hasRemediation ? `
                        <div class="cve-remediation-indicator">
                            ${cve.remediationLinks.length} Fix${cve.remediationLinks.length > 1 ? 'es' : ''} Available
                        </div>
                    ` : `
                        <div class="cve-remediation-indicator no-links">
                            See CISA Guidance
                        </div>
                    `}
                    <div class="cve-due-date">
                        Due: ${formatDate(cve.dueDate)}
                    </div>
                </div>
            </div>
        `;
    });

    html += `
        </div>
        <div class="cve-view-all">
            <a href="https://www.cisa.gov/known-exploited-vulnerabilities-catalog" 
               target="_blank" 
               class="cve-view-all-btn">
                View Full CISA KEV Catalog ‚Üí
            </a>
        </div>
    `;

    container.innerHTML = html;
}

// Open CVE modal with full details
function openCVEModal(cveId) {
    const cve = cveData.cves.find(c => c.cveId === cveId);
    if (!cve) return;

    const modal = document.getElementById('cveModal') || createCVEModal();
    const severityColor = getSeverityColor(cve.severity);

    const modalContent = `
        <div class="cve-modal-header" style="border-left: 5px solid ${severityColor}">
            <button class="cve-modal-close" onclick="closeCVEModal()">‚úï</button>
            <div class="cve-modal-title-section">
                <h2 class="cve-modal-title">${cve.cveId}</h2>
                <div class="cve-severity-badge ${cve.severity.toLowerCase()}" style="background: ${severityColor}">
                    ${cve.severity}
                </div>
                ${cve.isZeroDay ? '<div class="cve-zero-day-badge">ZERO DAY</div>' : ''}
            </div>
        </div>

        <div class="cve-modal-body">
            ${cve.epss ? `
            <div class="cve-modal-section cve-epss-section">
                <h3>Exploit Prediction (EPSS)</h3>
                <div class="cve-epss-meter">
                    <div class="cve-epss-meter-header">
                        <div class="cve-epss-score-large ${getEPSSClass(cve.epss.score)}">
                            ${(cve.epss.score * 100).toFixed(1)}%
                        </div>
                        <div class="cve-epss-meta">
                            <span class="cve-epss-percentile">Top ${((1 - cve.epss.percentile) * 100).toFixed(1)}% most likely</span>
                            <span class="cve-epss-date">Updated: ${cve.epss.date}</span>
                        </div>
                    </div>
                    <div class="cve-epss-track-large">
                        <div class="cve-epss-fill-large ${getEPSSClass(cve.epss.score)}" style="width: ${cve.epss.score * 100}%"></div>
                        <div class="cve-epss-markers">
                            <span style="left: 10%">10%</span>
                            <span style="left: 50%">50%</span>
                            <span style="left: 90%">90%</span>
                        </div>
                    </div>
                    <p class="cve-epss-explanation">
                        EPSS predicts the probability this CVE will be exploited in the wild within the next 30 days.
                        ${cve.epss.score >= 0.7 ? '<strong>HIGH LIKELIHOOD - Patch immediately!</strong>' :
                cve.epss.score >= 0.3 ? '<strong>Moderate likelihood - Prioritize patching.</strong>' :
                    'Lower likelihood, but still monitor.'}
                    </p>
                </div>
            </div>
            ` : ''}

            ${cve.patchPriority && cve.patchPriority !== 'UNKNOWN' ? `
            <div class="cve-modal-section">
                <h3>Patch Priority</h3>
                <div class="cve-priority-display ${cve.patchPriority.toLowerCase().replace('-', '')}">
                    <span class="cve-priority-icon">${getPriorityIcon(cve.patchPriority)}</span>
                    <span class="cve-priority-text">${cve.patchPriority}</span>
                    <span class="cve-priority-desc">${getPriorityDescription(cve.patchPriority)}</span>
                </div>
            </div>
            ` : ''}

            <div class="cve-modal-section">
                <h3>Vulnerability Details</h3>
                <div class="cve-detail-grid">
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Vendor:</span>
                        <span class="cve-detail-value">${cve.vendor}</span>
                    </div>
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Product:</span>
                        <span class="cve-detail-value">${cve.product}</span>
                    </div>
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">CVSS Score:</span>
                        <span class="cve-detail-value">${cve.cvssScore} (${cve.cvssVersion || '3.x'})</span>
                    </div>
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Date Added:</span>
                        <span class="cve-detail-value">${formatDate(cve.dateAdded)}</span>
                    </div>
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">Remediation Due:</span>
                        <span class="cve-detail-value">${formatDate(cve.dueDate)}</span>
                    </div>
                    ${cve.epss ? `
                    <div class="cve-detail-item">
                        <span class="cve-detail-label">EPSS Score:</span>
                        <span class="cve-detail-value ${getEPSSClass(cve.epss.score)}">${(cve.epss.score * 100).toFixed(1)}%</span>
                    </div>
                    ` : ''}
                </div>
            </div>

            <div class="cve-modal-section">
                <h3>Description</h3>
                <p class="cve-modal-description">${cve.description}</p>
                ${cve.shortDescription ? `<p class="cve-modal-short-desc">${cve.shortDescription}</p>` : ''}
            </div>

            <div class="cve-modal-section">
                <h3>Required Action</h3>
                <div class="cve-required-action">
                    ${cve.requiredAction}
                </div>
            </div>

            ${cve.remediationLinks && cve.remediationLinks.length > 0 ? `
                <div class="cve-modal-section">
                    <h3>Vendor Patches & Advisories</h3>
                    <div class="cve-remediation-links">
                        ${cve.remediationLinks.map(link => `
                            <a href="${link.url}" target="_blank" class="cve-remediation-link">
                                <span class="remediation-link-text">${link.title}</span>
                                <span class="remediation-link-arrow">‚Üí</span>
                            </a>
                        `).join('')}
                    </div>
                </div>
            ` : ''}

            <div class="cve-modal-section">
                <h3>Official References</h3>
                <div class="cve-official-links">
                    <a href="${cve.nvdUrl}" target="_blank" class="cve-official-link">
                        <span>NVD Details</span>
                        <span>‚Üí</span>
                    </a>
                    <a href="${cve.cisaUrl}" target="_blank" class="cve-official-link">
                        <span>CISA KEV Catalog</span>
                        <span>‚Üí</span>
                    </a>
                </div>
            </div>
        </div>
    `;

    modal.querySelector('.cve-modal-content-inner').innerHTML = modalContent;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Close CVE modal
function closeCVEModal() {
    const modal = document.getElementById('cveModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Create CVE modal element
function createCVEModal() {
    const modal = document.createElement('div');
    modal.id = 'cveModal';
    modal.className = 'cve-modal';
    modal.innerHTML = `
        <div class="cve-modal-overlay" onclick="closeCVEModal()"></div>
        <div class="cve-modal-content">
            <div class="cve-modal-content-inner"></div>
        </div>
    `;
    document.body.appendChild(modal);
    return modal;
}

// Get severity color
function getSeverityColor(severity) {
    const colors = {
        'CRITICAL': 'linear-gradient(135deg, #FF3D3D, #C41E3A)',
        'HIGH': 'linear-gradient(135deg, #FF8C00, #FF6B35)',
        'MEDIUM': 'linear-gradient(135deg, #FFA500, #FFB84D)',
        'LOW': 'linear-gradient(135deg, #4CAF50, #66BB6A)'
    };
    return colors[severity] || colors['HIGH'];
}

// Get EPSS color class based on score
function getEPSSClass(score) {
    if (score >= 0.7) return 'epss-critical';
    if (score >= 0.5) return 'epss-high';
    if (score >= 0.3) return 'epss-medium';
    return 'epss-low';
}

// Get priority badge HTML
function getPriorityBadge(priority) {
    if (!priority || priority === 'UNKNOWN') return '';

    const badges = {
        'CRITICAL-URGENT': '<div class="cve-priority-badge urgent">URGENT</div>',
        'CRITICAL': '',  // Already shown by severity badge
        'HIGH': '',
        'MEDIUM': '',
        'LOW': ''
    };
    return badges[priority] || '';
}

// Get priority icon
function getPriorityIcon(priority) {
    const icons = {
        'CRITICAL-URGENT': 'üî•',
        'CRITICAL': '‚ö†Ô∏è',
        'HIGH': '‚ö°',
        'MEDIUM': 'üìã',
        'LOW': 'üìù'
    };
    return icons[priority] || 'üìå';
}

// Get priority description
function getPriorityDescription(priority) {
    const descriptions = {
        'CRITICAL-URGENT': 'Actively exploited or extremely high likelihood. Patch within 24-48 hours.',
        'CRITICAL': 'Very high severity or exploit likelihood. Patch within 7 days.',
        'HIGH': 'High severity with moderate exploit risk. Patch within 14 days.',
        'MEDIUM': 'Moderate risk. Include in next patch cycle.',
        'LOW': 'Lower risk. Monitor and patch when convenient.'
    };
    return descriptions[priority] || 'Assess and prioritize based on your environment.';
}

// Format date
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

// Show error message with retry
function showCVEError() {
    const container = document.getElementById('cveContainer');
    if (!container) return;

    // Use the LoadingStates utility if available
    if (typeof LoadingStates !== 'undefined' && LoadingStates.createError) {
        container.innerHTML = LoadingStates.createError(
            'Unable to load CVE data. Please try again.',
            () => {
                // Retry loading with loading state
                container.innerHTML = `
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Retrying...</div>
                    </div>
                `;
                loadCVEData();
            }
        );
    } else {
        // Fallback with manual retry
        container.innerHTML = `
            <div class="error-state">
                <div class="error-state__icon"><i class="fas fa-exclamation-circle"></i></div>
                <div class="error-state__message">Unable to load CVE data. Please try again.</div>
                <button class="error-state__retry" onclick="loadCVEData()">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        `;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    if (document.getElementById('cveContainer')) {
        loadCVEData();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeCVEModal();
    }
});

// Update hero KEV count when CVE data loads
document.addEventListener('DOMContentLoaded', () => {
    // Update hero count after CVE data loads
    const originalLoadCVEData = window.loadCVEData;
    if (typeof originalLoadCVEData === 'function') {
        window.loadCVEData = async function () {
            await originalLoadCVEData();
            if (cveData && cveData.totalCVEs) {
                const heroCount = document.getElementById('heroKevCount');
                if (heroCount) {
                    heroCount.textContent = cveData.totalCVEs;
                }
            }
        };
    }
});
